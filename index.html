<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>AR English Eat - Present Simple Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Prompt', sans-serif; background: #0f172a; overscroll-behavior: none; }
        canvas { width: 100%; height: 100%; object-fit: cover; }
        .glass { background: rgba(17, 24, 39, 0.85); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .btn-game { background: linear-gradient(to bottom, #a855f7, #7e22ce); box-shadow: 0 4px 0 #581c87; transition: all 0.1s; cursor: pointer; }
        .btn-game:active { transform: translateY(2px); box-shadow: 0 2px 0 #581c87; }
        .mic-listening { animation: pulse 1.5s infinite; background: #ef4444 !important; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        #countdown { font-size: 8rem; text-shadow: 0 0 20px rgba(168, 85, 247, 0.8); color: white; font-weight: 900; }
        .hint-animate { animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden text-white select-none">

    <div id="game-container" class="relative w-full h-full flex justify-center items-center">
        <video id="input_video" class="hidden" playsinline></video>
        <canvas id="output-canvas" class="absolute inset-0"></canvas>
        
        <div id="ui-layer" class="absolute inset-0 pointer-events-none flex flex-col justify-between p-4 z-10">
            <div id="hud" class="glass rounded-2xl p-3 flex flex-col gap-2 opacity-0 transition-opacity duration-500">
                <div class="flex justify-between items-center px-1">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-purple-600 rounded-lg flex items-center justify-center font-bold text-xl shadow-lg" id="score-box">0</div>
                        <div class="text-xs text-gray-300"><div class="font-bold text-white uppercase" id="player-label">Player</div></div>
                    </div>
                </div>
                <div id="question-text" class="text-center text-yellow-300 text-lg md:text-xl font-bold py-2 bg-black/40 rounded-lg px-2 break-words">...</div>
            </div>
            <div id="toast" class="self-center glass px-8 py-3 rounded-full text-base font-bold hidden shadow-2xl transition-all"></div>
        </div>

        <div id="screen-login" class="absolute inset-0 bg-[#0f172a] z-50 flex flex-col justify-center items-center p-6 text-center">
            <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500 mb-8 uppercase tracking-tighter">AR English Eat</h1>
            <div class="glass p-8 rounded-3xl w-full max-w-sm space-y-4 pointer-events-auto">
                <input type="text" id="inp-name" class="w-full bg-gray-800 border border-gray-600 rounded-xl p-3 text-white outline-none" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô">
                <input type="number" id="inp-num" class="w-full bg-gray-800 border border-gray-600 rounded-xl p-3 text-white outline-none" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà">
                <button onclick="showRules()" class="w-full btn-game py-4 rounded-xl font-bold text-lg">üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°</button>
            </div>
        </div>

        <div id="screen-rules" class="absolute inset-0 bg-[#0f172a]/95 z-[60] hidden flex flex-col justify-center items-center p-6">
            <div class="glass p-6 rounded-3xl w-full max-w-md space-y-6 border-purple-500/50 border-2 pointer-events-auto text-center">
                <h2 class="text-2xl font-black text-purple-400">üìú ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
                <div class="text-left space-y-3 text-sm">
                    <div class="bg-green-900/20 p-3 rounded-xl border border-green-500/30">
                        <p>‚úÖ <b>‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å:</b> +5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                        <p>‚úÖ <b>‡∏û‡∏π‡∏î‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡∏π‡∏Å:</b> +5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                    </div>
                    <div class="bg-red-900/20 p-3 rounded-xl border border-red-500/30">
                        <p>‚ùå <b>‡∏Å‡∏¥‡∏ô‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î:</b> -5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                        <p>‚ùå <b>‡∏Å‡∏î‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå:</b> -2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
                    </div>
                    <p class="text-yellow-400 italic text-center text-[10px] mt-2">*‡∏´‡∏≤‡∏Å‡∏û‡∏π‡∏î‡∏ú‡∏¥‡∏î 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏à‡∏∞‡∏°‡∏µ‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏Ç‡∏∂‡πâ‡∏ô</p>
                </div>
                <button onclick="startGameFlow()" class="w-full btn-game py-4 rounded-xl font-bold text-xl">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß!</button>
            </div>
        </div>

        <div id="countdown-layer" class="absolute inset-0 z-[70] hidden flex items-center justify-center bg-black/40">
            <div id="countdown">3</div>
        </div>

        <div id="screen-speech" class="absolute inset-0 bg-black/95 z-30 hidden flex-col justify-center items-center text-center p-6 backdrop-blur-xl">
            <h2 class="text-xl text-purple-300 font-bold mb-2 uppercase italic tracking-widest">Speak the word</h2>
            <div id="sp-word" class="text-6xl font-extrabold text-white mb-2 tracking-tight">...</div>
            
            <div id="sp-reading" class="text-xl text-purple-400 font-bold mb-4 italic invisible bg-purple-900/30 px-4 py-2 rounded-lg border border-purple-500/30">...</div>
            
            <div id="sp-meaning" class="text-xl text-yellow-400 font-bold bg-gray-800 px-6 py-2 rounded-full mb-12">...</div>
            
            <button id="mic-btn" onclick="toggleListening()" class="w-24 h-24 flex items-center justify-center bg-purple-600 rounded-full border-4 border-purple-400 pointer-events-auto shadow-2xl">
                <div id="mic-icon" class="text-4xl">üéôÔ∏è</div>
            </button>
            <p id="sp-status" class="mt-8 text-white/70">‡πÅ‡∏ï‡∏∞‡πÑ‡∏°‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</p>
            <button onclick="endSpeech(false)" class="mt-12 text-sm text-gray-400 underline pointer-events-auto">‡∏Ç‡πâ‡∏≤‡∏°‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ (-2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</button>
        </div>

        <div id="screen-end" class="absolute inset-0 bg-[#0f172a] z-50 hidden flex flex-col justify-center items-center p-6 text-center">
            <h1 class="text-5xl font-black text-white mb-4 uppercase">‡∏à‡∏ö‡πÄ‡∏Å‡∏°!</h1>
            <div class="bg-gray-800/50 p-8 rounded-full border-4 border-yellow-400 mb-8 w-44 h-44 flex items-center justify-center shadow-[0_0_30px_rgba(234,179,8,0.3)]">
                <div><div class="text-xs text-gray-400 font-bold uppercase tracking-widest">Final Score</div><div id="final-score" class="text-5xl font-black text-yellow-400">0</div></div>
            </div>
            <p id="save-status" class="text-blue-400 animate-pulse mb-6 italic">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô...</p>
            <button onclick="location.reload()" class="w-full max-w-xs bg-purple-600 py-4 rounded-xl font-bold pointer-events-auto shadow-xl hover:bg-purple-500 transition-colors">‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</button>
        </div>
    </div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwrdNIBNWMhLCMaGEbqCif5Ic3IO5W2PDrESxW5oAFW8iLYZIExjeIFsttkiqprcPE/exec";

// ‡πÇ‡∏à‡∏ó‡∏¢‡πå 10 ‡∏Ç‡πâ‡∏≠ ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ñ‡∏≥‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡πâ‡∏≤‡∏¢ (Final Sound)
const QUESTIONS = [
    { q: "A boy ______ a book before bed.", c: "reads", w: ["read", "reading"], m: "‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠", p: "‡∏£‡∏µ‡∏î‡∏™‡πå (‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏™‡∏∂ ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≥)" },
    { q: "The cats ______ milk every day.", c: "drink", w: ["drinks", "drinking"], m: "‡πÅ‡∏°‡∏ß(‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß)‡∏î‡∏∑‡πà‡∏°‡∏ô‡∏°", p: "‡∏î‡∏£‡∏¥‡∏á‡∏Å‡πå (‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Å‡∏∂ ‡πÄ‡∏ö‡∏≤‡πÜ)" },
    { q: "Birds ______ in the sky.", c: "fly", w: ["flies", "flying"], m: "‡∏û‡∏ß‡∏Å‡∏ô‡∏Å‡∏ö‡∏¥‡∏ô‡∏ö‡∏ô‡∏ó‡πâ‡∏≠‡∏á‡∏ü‡πâ‡∏≤", p: "‡∏ü‡∏•‡∏≤‡∏¢" },
    { q: "He ______ coffee every morning.", c: "drinks", w: ["drink", "drinking"], m: "‡πÄ‡∏Ç‡∏≤‡∏î‡∏∑‡πà‡∏°‡∏Å‡∏≤‡πÅ‡∏ü‡∏ó‡∏∏‡∏Å‡πÄ‡∏ä‡πâ‡∏≤", p: "‡∏î‡∏£‡∏¥‡∏á‡∏Å‡πå‡∏™ (‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏™‡∏∂ ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≥)" },
    { q: "We ______ to the park on Sundays.", c: "walk", w: ["walks", "walking"], m: "‡∏û‡∏ß‡∏Å‡πÄ‡∏£‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡πÑ‡∏õ‡∏™‡∏ß‡∏ô‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞", p: "‡∏ß‡∏≠‡∏•‡πå‡∏Ñ (‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≤‡πÜ)" },
    { q: "A rabbit ______ very fast.", c: "runs", w: ["run", "running"], m: "‡∏Å‡∏£‡∏∞‡∏ï‡πà‡∏≤‡∏¢‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å", p: "‡∏£‡∏±‡∏ô‡∏™‡πå (‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏™‡∏∂ ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≥)" },
    { q: "Teachers ______ the students.", c: "help", w: ["helps", "helping"], m: "‡∏Ñ‡∏£‡∏π‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô", p: "‡πÄ‡∏Æ‡∏•‡∏õ‡πå (‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏û‡∏∂ ‡πÄ‡∏ö‡∏≤‡πÜ)" },
    { q: "She ______ a beautiful song.", c: "sings", w: ["sing", "singing"], m: "‡πÄ‡∏ò‡∏≠‡∏£‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏•‡∏á‡πÑ‡∏û‡πÄ‡∏£‡∏≤‡∏∞", p: "‡∏ã‡∏¥‡∏á‡∏™‡πå (‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏™‡∏∂ ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≥)" },
    { q: "Water ______ at 100 degrees.", c: "boils", w: ["boil", "boiling"], m: "‡∏ô‡πâ‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏î‡∏ó‡∏µ‡πà 100 ‡∏≠‡∏á‡∏®‡∏≤", p: "‡∏ö‡∏≠‡∏¢‡∏•‡πå‡∏™ (‡πÄ‡∏ô‡πâ‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏™‡∏∂ ‡∏ó‡πâ‡∏≤‡∏¢‡∏Ñ‡∏≥)" },
    { q: "You ______ very kind today.", c: "look", w: ["looks", "looking"], m: "‡∏Ñ‡∏∏‡∏ì‡∏î‡∏π‡πÉ‡∏à‡∏î‡∏µ‡∏à‡∏±‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", p: "‡∏•‡∏∏‡πâ‡∏Ñ (‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Ñ‡∏∑‡∏≠ ‡πÄ‡∏ö‡∏≤‡πÜ)" }
];

const CFG = { gravity: 1.7, spawnRate: 110, eatDist: 90, mouthThresh: 0.05 };
window.G = {
    playing: false, score: 0, qIdx: 0, items: [], 
    mouth: {x:0, y:0, open:false}, user: {name:'', number:''},
    pendingItem: null, isListening: false, 
    wrongCount: 0, passedWords: [], skippedWords: []
};

// --- Audio Feedback ---
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
function playSound(freq, type = 'sine', vol = 0.15) {
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
    osc.start(); osc.stop(audioCtx.currentTime + 0.2);
}

// --- Data Submission ---
async function sendData() {
    const payload = {
        name: G.user.name, number: G.user.number,
        passed: G.passedWords.join(", "), skipped: G.skippedWords.join(", "), score: G.score
    };
    try {
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        document.getElementById('save-status').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!";
    } catch(e) { 
        document.getElementById('save-status').innerText = "‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"; 
    }
}

let lastCameraFrame = null, camReady = false, animId = null;
const ctx = document.getElementById('output-canvas').getContext('2d');
const videoElement = document.getElementById('input_video');

function showRules() {
    const name = document.getElementById('inp-name').value.trim();
    if (!name) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô");
    G.user = { name, number: document.getElementById('inp-num').value.trim() };
    document.getElementById('screen-login').classList.add('hidden');
    document.getElementById('screen-rules').classList.remove('hidden');
}

function startGameFlow() {
    document.getElementById('screen-rules').classList.add('hidden');
    document.getElementById('player-label').innerText = G.user.name;
    initCamera();
}

async function initCamera() {
    const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
    faceMesh.setOptions({
        maxNumFaces: 1, refineLandmarks: true, 
        minDetectionConfidence: 0.5, minTrackingConfidence: 0.5,
        selfieMode: true
    });
    faceMesh.onResults(onFaceResults);
    const camera = new Camera(videoElement, { onFrame: async () => { await faceMesh.send({image: videoElement}); }, width: 1280, height: 720 });
    camera.start();
}

function onFaceResults(res) {
    lastCameraFrame = res.image;
    if (res.multiFaceLandmarks && res.multiFaceLandmarks.length > 0) {
        const w = window.innerWidth, h = window.innerHeight, lm = res.multiFaceLandmarks[0];
        const uLip = lm[13], lLip = lm[14], h_top = lm[10], h_bot = lm[152];
        G.mouth.open = Math.abs(uLip.y - lLip.y) > (Math.abs(h_top.y - h_bot.y) * CFG.mouthThresh);
        G.mouth.x = uLip.x * w; 
        G.mouth.y = uLip.y * h;
        if (!camReady) { camReady = true; runCountdown(); }
    }
}

function runCountdown() {
    const el = document.getElementById('countdown-layer');
    const txt = document.getElementById('countdown');
    el.classList.remove('hidden');
    let count = 3;
    const timer = setInterval(() => {
        count--;
        if (count > 0) { txt.innerText = count; playSound(440); }
        else { clearInterval(timer); el.classList.add('hidden'); playSound(880); realStart(); }
    }, 1000);
}

function realStart() { 
    G.playing = true; 
    document.getElementById('hud').classList.replace('opacity-0', 'opacity-100'); 
    loadLevel(); 
    gameLoop(); 
}

function gameLoop() {
    if (!G.playing) return;
    const w = ctx.canvas.width = window.innerWidth, h = ctx.canvas.height = window.innerHeight;
    ctx.save();
    if (lastCameraFrame) ctx.drawImage(lastCameraFrame, 0, 0, w, h);
    ctx.restore();

    // Visual mouth guide
    ctx.beginPath(); 
    ctx.arc(G.mouth.x, G.mouth.y, G.mouth.open ? 35 : 15, 0, Math.PI * 2);
    ctx.lineWidth = 5; ctx.strokeStyle = G.mouth.open ? '#4ade80' : '#f472b6'; 
    ctx.stroke();

    if (Math.random() * 1000 < (1000 / CFG.spawnRate)) spawnItem();

    ctx.font = "bold 24px 'Prompt'"; ctx.textAlign = "center";
    for (let i = G.items.length - 1; i >= 0; i--) {
        let it = G.items[i]; 
        it.y += it.vy; it.x += it.vx;
        
        const tw = ctx.measureText(it.text).width + 30;
        ctx.fillStyle = "rgba(124, 58, 237, 0.9)";
        ctx.beginPath(); ctx.roundRect(it.x - tw/2, it.y - 25, tw, 50, 15); ctx.fill();
        ctx.fillStyle = "white"; ctx.fillText(it.text, it.x, it.y + 10);

        if (Math.sqrt((it.x - G.mouth.x)**2 + (it.y - G.mouth.y)**2) < CFG.eatDist && G.mouth.open) {
            handleEat(it, i);
        } else if (it.y > h + 100) {
            G.items.splice(i, 1);
        }
    }
    animId = requestAnimationFrame(gameLoop);
}

function spawnItem() {
    const q = QUESTIONS[G.qIdx];
    const isCorrect = Math.random() > 0.5;
    G.items.push({
        x: Math.random() * (window.innerWidth - 150) + 75, y: -50,
        text: isCorrect ? q.c : q.w[Math.floor(Math.random() * q.w.length)],
        type: isCorrect ? 'c' : 'w', vx: (Math.random() - 0.5) * 1.2, vy: Math.random() * 1.2 + CFG.gravity
    });
}

function handleEat(item, idx) {
    if (item.type === 'c') {
        playSound(660, 'sine', 0.2);
        G.items = []; G.pendingItem = item; G.playing = false; cancelAnimationFrame(animId);
        G.score += 5; G.wrongCount = 0; // Reset count for new word
        
        const speechScr = document.getElementById('screen-speech');
        const readingEl = document.getElementById('sp-reading');
        
        speechScr.classList.replace('hidden', 'flex');
        readingEl.classList.add('invisible'); // Hide hint initially
        readingEl.innerText = QUESTIONS[G.qIdx].p;
        
        document.getElementById('sp-word').innerText = item.text;
        document.getElementById('sp-meaning').innerText = QUESTIONS[G.qIdx].m;
        
        updateHUD(); resetMicUI();
    } else {
        playSound(220, 'square', 0.1);
        G.items.splice(idx, 1); 
        G.score = Math.max(0, G.score - 5); updateHUD();
        showToast(`‡∏Å‡∏¥‡∏ô‡∏ú‡∏¥‡∏î‡∏ô‡∏∞! -5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 'red');
    }
}

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;

function toggleListening() { 
    if (G.isListening) { recognition.stop(); return; } 
    startSpeechTask(); 
}

function startSpeechTask() {
    G.isListening = true;
    document.getElementById('mic-btn').classList.add('mic-listening');
    document.getElementById('sp-status').innerText = "‡∏ü‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞... ‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô";
    
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.onresult = (e) => {
        const spokenRaw = e.results[0][0].transcript.toLowerCase();
        const spokenClean = spokenRaw.replace(/[^a-z]/g, '');
        const target = G.pendingItem.text.toLowerCase();
        
        // Flexible matching logic
        const isMatch = spokenClean.includes(target) || 
                        (target.length > 3 && spokenClean.includes(target.slice(0, -1)));

        if (isMatch) {
            playSound(880, 'sine', 0.2);
            endSpeech(true);
        } else {
            playSound(330, 'triangle', 0.1);
            G.wrongCount++;
            
            // Check if wrong 3 times
            if (G.wrongCount >= 3) {
                const hint = document.getElementById('sp-reading');
                hint.classList.remove('invisible');
                hint.classList.add('hint-animate');
                document.getElementById('sp-status').innerText = "‡∏•‡∏≠‡∏á‡∏î‡∏π‡∏Ñ‡∏≥‡πÉ‡∏ö‡πâ‡∏™‡∏µ‡∏°‡πà‡∏ß‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô!";
            } else {
                document.getElementById('sp-status').innerText = `‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡∏¢‡∏¥‡∏ô‡∏ß‡πà‡∏≤ "${spokenRaw}"`;
            }
        }
    };
    recognition.onend = resetMicUI;
    recognition.start();
}

function resetMicUI() { 
    G.isListening = false; 
    document.getElementById('mic-btn').classList.remove('mic-listening'); 
    if (!G.playing && !document.getElementById('screen-speech').classList.contains('hidden')) {
        if (G.wrongCount < 3) document.getElementById('sp-status').innerText = "‡πÅ‡∏ï‡∏∞‡πÑ‡∏°‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
    }
}

function endSpeech(success) {
    document.getElementById('screen-speech').classList.replace('flex', 'hidden');
    if (success) { 
        G.score += 5; 
        G.passedWords.push(G.pendingItem.text); 
        showToast(`Correct! +5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 'green'); 
    } else { 
        G.score = Math.max(0, G.score - 2); 
        G.skippedWords.push(G.pendingItem.text); 
        showToast(`‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ -2 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô`, 'red'); 
    }
    
    if (++G.qIdx >= QUESTIONS.length) {
        finishGame();
    } else {
        G.playing = true; 
        loadLevel(); 
        gameLoop(); 
    }
}

function finishGame() {
    G.playing = false; 
    document.getElementById('screen-end').classList.replace('hidden', 'flex');
    document.getElementById('final-score').innerText = G.score;
    sendData();
}

function loadLevel() { 
    document.getElementById('question-text').innerText = `${G.qIdx + 1}. ${QUESTIONS[G.qIdx].q}`; 
    updateHUD(); 
}

function updateHUD() { document.getElementById('score-box').innerText = G.score; }

function showToast(msg, c) {
    const t = document.getElementById('toast');
    t.innerText = msg; t.className = `self-center glass px-8 py-3 rounded-full text-base font-bold ${c === 'green' ? 'text-green-400' : 'text-red-400'}`;
    t.classList.remove('hidden'); setTimeout(() => t.classList.add('hidden'), 1500);
}
</script>
</body>
</html>
